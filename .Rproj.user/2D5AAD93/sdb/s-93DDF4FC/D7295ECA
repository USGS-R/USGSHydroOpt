{
    "contents" : "%\\VignetteIndexEntry{Introduction to the USGSHydroOpt package}\n%\\VignetteEngine{knitr::knitr}\n%\\VignetteDepends{}\n%\\VignetteSuggests{}\n%\\VignetteImports{reshape2}\n%\\VignettePackage{USGSHydroOpt}\n\n\\documentclass[a4paper,11pt]{article}\n\\usepackage{amsmath}\n\\usepackage{times}\n\\usepackage{hyperref}\n\\usepackage[numbers, round]{natbib}\n\\usepackage[american]{babel}\n\\usepackage{authblk}\n\\usepackage{subfig}\n\\usepackage{placeins}\n\\usepackage{footnote}\n\\usepackage{tabularx}\n\\usepackage{parskip}\n\\usepackage{threeparttable}\n\\renewcommand\\Affilfont{\\itshape\\small}\n\n\\renewcommand{\\topfraction}{0.85}\n\\renewcommand{\\textfraction}{0.1}\n\\usepackage{graphicx}\n\n\\textwidth=6.5in\n\\textheight=9.2in\n\\parskip=.3cm\n\\oddsidemargin=.1in\n\\evensidemargin=.1in\n\\headheight=-.3in\n\n%------------------------------------------------------------\n% newcommand\n%------------------------------------------------------------\n\\newcommand{\\scscst}{\\scriptscriptstyle}\n\\newcommand{\\scst}{\\scriptstyle}\n\\newcommand{\\Robject}[1]{{\\texttt{#1}}}\n\\newcommand{\\Rfunction}[1]{{\\texttt{#1}}}\n\\newcommand{\\Rclass}[1]{\\textit{#1}}\n\\newcommand{\\Rpackage}[1]{\\textit{#1}}\n\\newcommand{\\Rexpression}[1]{\\texttt{#1}}\n\\newcommand{\\Rmethod}[1]{{\\texttt{#1}}}\n\\newcommand{\\Rfunarg}[1]{{\\texttt{#1}}}\n\n\\begin{document}\n\n<<openLibrary, echo=FALSE>>=\nlibrary(xtable)\noptions(continue=\" \")\noptions(width=60)\nlibrary(knitr)\n\n@\n\n\n<<include=TRUE ,echo=FALSE,eval=TRUE>>=\nopts_chunk$set(highlight=TRUE, tidy=TRUE, keep.space=TRUE, keep.blank.space=FALSE, keep.comment=TRUE, concordance=TRUE,tidy=FALSE,comment=\"\")\n\nknit_hooks$set(inline = function(x) {\n   if (is.numeric(x)) round(x, 3)})\nknit_hooks$set(crop = hook_pdfcrop)\n\n@\n\n%------------------------------------------------------------\n\\title{USGSHydroOpt : Tools for Optical Analysis of Water}\n%------------------------------------------------------------\n\\author[1]{Samuel Christel}\n\\author[1]{Steve Corsi}\n\\affil[1]{United States Geological Survey}\n\n<<include=TRUE ,echo=FALSE,eval=TRUE>>=\nopts_chunk$set(highlight=TRUE, tidy=TRUE, keep.space=TRUE, keep.blank.space=FALSE, keep.comment=TRUE, tidy=FALSE,comment=\"\")\nknit_hooks$set(inline = function(x) {\n   if (is.numeric(x)) round(x, 3)})\nknit_hooks$set(crop = hook_pdfcrop)\n@\n\n\n\\maketitle\n\\tableofcontents\n\n%------------------------------------------------------------\n\\section{Introduction to USGSHydroOpt}\n%------------------------------------------------------------ \nThe USGSHydroOpt package was created to streamline the process of creating optical summary variables and excitation-emission (EEMs) plots for absorbance and fluoresence data collected from various freshwater sources. Examples of optical summary variables that can be produced with this package include various absorbance peaks, The functions in this package were designed to operate on dataframes with a standard data structures. This package is not amenable to dataframes or arrays that do not fit the prescribed formats. The example dataframes and array in this package illustrate exactly how data structures should be formatted, and the examples illustrate how the functions operate on the data structures. Depicted below is an example of an EEMs plot produced with this package. The user is encouraged to step through each piece of R code as it is introduced in this document. In many instances a sample of the function output is provided (plots, tables), but not in all cases.\n\n<<fig=TRUE, echo=FALSE>>=\nlibrary(\"USGSHydroOpt\")\nGRnum <- \"gr15222\"\nmat <- a[,,GRnum]\nEx <- as.numeric(names(a[,1,1]))\nEm <- as.numeric(names(a[1,,1]))\nnlevels <- 50\nPeaks <- ex_ems\npeakCol <- \"Peak\"\npeakEx <- \"ExCA\"\npeakEm <- \"EmCA\"\nmainTitle <- \"Example EEMs Plot\"\nexampleEEMs <- plotEEMs2(mat=mat,Ex=Ex,Em=Em,nlevels=nlevels,Peaks=Peaks,peakCol=peakCol,peakEx=peakEx,peakEm=peakEm,mainTitle=mainTitle)\n@\n\n%------------------------------------------------------------\n\\section{Required Data Formats}\n%------------------------------------------------------------ \nThe functions contained in USGSHydroOpt operate on dataframes with defined structures. Users interested in using USGSHydroOpt should format dataframes according to the structures defined in this section.\n\n%------------------------------------------------------------\n\\subsection{Absorbance Data}\n%------------------------------------------------------------\nAbsorbance data used by functions in USGSHydroOpt should be formatted such that each sample occupies a column, and one column contains the wavelength (nm) for which the absorbance measurement was measured (\\emph{See example Table 2.1 below}). The column with the wavelengths in Table 2.1 does not need to be called \"wavelengths,\" as it is named in the example dataframe below. Since this package was developed primarily for USGS activities, the default for naming samples is \"gr\" then the sample number. This convention was started by the USGS California Water Sciences Center (CA WSC) and the USGS Wisconsin Water Science Center (WI WSC) follows the same naming convention to ensure standardization.\n\n<<dfabs, echo=FALSE>>=\nrequire(xtable)\nhead(dfabs[,c(1:4,266)])\n@\n\n%------------------------------------------------------------\n\\subsection{Fluoresence Data}\n%------------------------------------------------------------\nFluoresence data used by functions in USGSHydroOpt should also be formatted such that each sample occupies a column, and one column contains the excitation emission wavelength pairs (nm) for which the fluoresence measurment was measured (\\emph{See example Table 2.2 below}). The column with the excitation emission pairs in Table 2.2 does not need to be called \"Wavelength.Pairs,\" as it is in the example dataframe below. Again since this package was developed for USGS activities, the default sample naming convention is \"gr\" followed by the sample number.\n\n<<dfFluor, echo=FALSE>>=\nrequire(xtable)\nhead(dfFluor[,c(1:5)])\n@\n\n%------------------------------------------------------------\n\\subsection{Spectral Slopes Data}\n%------------------------------------------------------------\nInformation on the upper and lower wavelength (nm) for which a spectral slope should be calculated needs to be stored in a dataframe if USGSHydroOpt is used. The dataframe should contain exactly three columns. The first column should contain the upper wavelength, the second column should contain the lower wavelength, and the third column should contain the name of the spectral slope being calculated (\\emph{See example Table 2.3 below}). The columns in Table 2.3 need to be in this exact order, although the names of the columns may be different. The data types for each column are integer, integer, and character, respectively. More spectral slopes can be added to the table than specified in the example dataframe below.\n\n<<dfsags, echo=FALSE>>=\nrequire(xtable)\ndfsags\n@\n\n%------------------------------------------------------------\n\\subsection{Optical Summary Data}\n%------------------------------------------------------------\nThis is the dataframe that contains many of the summary optical variables that can be produced using functions in USGSHydroOpt (\\emph{See example Table 2.4a below}). The functions in USGSHydroOpt calculate summary optical variables and add to a dataframe formatted according to Table 2.4a below.  The example dataframe below is how the WI WSC stores optical summary variables. Note that this dataframe can contain other columns with metadata, for example, the sample data and time, the sample ID, or whether or not the sample went through QA/QC.\n\n<<dfsummary, echo=FALSE>>=\nrequire(xtable)\nhead(dfsummary[,c(1,22,23,25,30,44,47)])\n@\n\nHowever, also note that summary optical variable names in the dataframe must be identical to those specified in Table 2.4b below. \n\n<<colnames(dfsummary)[11:68], echo=FALSE>>=\nrequire(xtable)\ncolnames(dfsummary)[11:68]\n@\n\n%------------------------------------------------------------\n\\subsection{Excitation-Emission (EEMs) Peak Data}\n%------------------------------------------------------------\nThe EEMs peak data contains three columns listing the name of a characterized EEM peak along with the corresponding wavelengths (nm) (\\emph{See example Table 2.5 below}). The first column, in Table 2.5, \"Peak,\" contains the name of the characterized EEM peak. The next two columns in Table 2.5 contain the excitation and emission wavelengths (nm) at which a given peak occurs. The column names must be identical to those displayed in the example below, although the order of the columns can be different. \n\n<<ex_ems, echo=FALSE>>=\nrequire(xtable)\nex_ems\n@\n\n%------------------------------------------------------------\n\\subsection{Optical Ratio and Signals Data}\n%------------------------------------------------------------\nThis dataframe contains one column called \"ratioSignals\" that contains all of the summary optical variables currently identified by the WI WSC (\\emph{See example Table 2.6 below}). Note that these are the same variables as those listed in Table 2.4b. The first column must contain the various \"ratioSignals\" that the user desires, although the column name need not be \"ratioSignals\"\n\n<<ratioSignals, echo=FALSE>>=\nrequire(xtable)\nratioSignals\n@\n\n%------------------------------------------------------------\n\\subsection{Optical Signals Data}\n%------------------------------------------------------------\nThis dataframe is similar to \"ratioSignals\" except it provides more metadata about peaks characterized for EEMs plots. The dataframe should contain six columns (\\emph{See example Table 2.7 below}). The first column in Table 2.7, \"Peak,\" contains the name of the characterized EEM peak. The next two columns, \"Ex1\" and \"Ex2,\" contain the excitation wavelength range (nm) for a given peak. \"Ex1\" is the lower wavelength and \"Ex2\" is the upper wavelength for the excitation wavelength range (nm) for a given peak. Similarily, \"Em1\" and \"Em2\" contain the emission wavelength range (nm) for a given peak. The final column, \"Source,\" lists the source that characterized the peak. The last column, \"Source,\" is not required. The user must exactly replicate the column names in Table 2.7 in order for the code in USGSHydroOpt to run.\n\n<<signals, echo=FALSE>>=\nrequire(xtable)\nsignals\n@\n\n%------------------------------------------------------------\n\\subsection{3-Dimensional Excitation-Emission Array}\n%------------------------------------------------------------\nA 3-D array with fluoresence data is used by many of the functions in USGSHydroOpt. The first dimension contains the excitation wavelengths (nm) as data type character at which a given fluoresence measurement was made. The second dimension contains the emission wavelengths (nm) as data type character at which a given fluoresence measurement was made. The third dimension contains the sample numbers as data type character for a given observation. The user must ensure that the third dimension of the array are sample numbers. Again, in this example the default \"gr\" followed by the sample number is used as a naming convention for samples.\n\nTo view the headers for each dimension using the following commands in R consider the example 3-D EEM array included with the USGSHydroOpt Package: \n\n<<array, echo=TRUE, eval=TRUE,tidy=TRUE>>=\n#this command shows the excitation wavelengths (nm)\ncolnames(a) \n\n#this command shows the emission wavelengths (nm)\nrownames(a) \n\n#this command shows the emission wavelengths (nm), only the first 20 shown for simplicity\nnames(a[1,1,])[1:20] \n@\n\nThe user should be aware of \\textbf{two important caveats}: (1) There should rarely be emission wavelengths below the excitation wavelength for a given fluoresence reading. Where this occurs an NA will be found in the 3-D EEMs array. (2) Intensities at an emission wavelength that is two times the excitation wavelength will be influence by second order Rayleigh scatter. \n\n%------------------------------------------------------------\n\\subsection{Creating a 3-Dimensional Excitation-Emission Array}\n%------------------------------------------------------------\nIn Section 2.8 the format of 3-D arrays of fluoresence data that can be used with USGSHydroOpt was discussed. USGSHydroOpt can also be used to produce such arrays given the appropriate input fluoresence dataframe. Below is an example of how USGSHydroOpt is used to accomplish this task: \n\n<< produce array workflow, echo=TRUE, eval=FALSE,tidy=TRUE>>=\n#set an arbitrary data frame (df) as dfFluor (the example fluoresence dataframe in USGSHydroOpt)\ndf <- dfFluor\n\n#define the column in dfFluor\nExEm <- \"Wavelength.Pairs\"\n\n#run the VectorizedTo3DArray function from USGSHydroOpt that creates a 3-D EEMs array given a vectorized fluoresence dataframe\naTest <- VectorizedTo3DArray(df,ExEm) \n@\n\nIn the example above, dfFluor is formatted according to the fluoresence dataframe discussed in Section 2.2. \n\n%------------------------------------------------------------\n\\section{Creating Summary Optical Variables}\n%------------------------------------------------------------ \nMost of the functions included in USGSHydroOpt are for creating variables that summarize optical data. Such variables can then be used in statistical modeling efforts aimed at describing observed phenomena in aquatic ecosystems. This sections steps through the six functions that USGSHydroOpt offers for creating such summary optical variables.\n\n%------------------------------------------------------------\n\\subsection{Creating Absorbance Coefficients}\n%------------------------------------------------------------ \nThe function getAbs opperates on a dataframe formatted according to Section 2.1. Specifically, it picks out absorbance coefficients for a defined set of wavelengths (nm) and adds those coefficients to an optical summary data frame formatted according to Section 2.4. Shown below is an example of how the function can be used.\n\n<<getAbs,echo=TRUE, eval=TRUE,tidy=TRUE>>=\n#assign a variable dataAbs to the absorbance dataframe included in USGSHydroOpt\ndataAbs <- dfabs\n\n#define the column with the wavelengths in dataAbs\nwaveCol <- \"wavelengths\"\n\n#define the wavelengths for which absorbance coefficients should be defined\nwavs <- c(430,530,630,730)\n\n#define which columns contain the absorbance data, by default per WI WSC and CA WSC samples start with \"gr\"\ncolSubsetString <- \"gr\"\n\n#assign a variable dataSummary to the dfsummary dataframe included in USGSHydroOpt\ndataSummary <- dfsummary\n\n#assign a variable grnum to the column in dataSummary with sample numbers\ngrnum <- \"GRnumber\"\n\n#use getAbs to produce absorbance coefficients \ntestAbs <- getAbs(dataAbs,waveCol,wavs, colSubsetString,dataSummary,grnum)\n\n#note that the absorbance coefficients as defined by wavs have been added to dataSummary\ncolnames(testAbs)[69:72]\n@\n\n%------------------------------------------------------------\n\\subsection{Spectral Slopes by Linear Regression}\n%------------------------------------------------------------ \nThe function getExpResid computes spectral slopes by a first order decay function determined by linear regression (Helms et al. 2008).The residual at a specified wavelength (nm) is then calculated based on the spectral slope. The residual at a given wavelength and spectral slope is then added to a summary dataframe formatted according to Section 2.4. Displayed below is an example of how the function can be used. The function produces a plot with the absorbance data for each sample. On the plot the red indicates the spectral slope model, the blue is the absorbance data in rangeGap, and the black is the data in rangeReg but not in rangeGap. The dataframe dataAbs is formatted according to Section 2.1, but is shortened. If the user calls \"pdf(genericName.pdf),\" \\emph{See }?pdf, then runs the function plots will be printed to the pdf in the working directory. \n\n<<getExpResid, echo=TRUE,eval=FALSE, tidy=TRUE>>=\n#absorbance wavelength (nm) for which residual is calculated\nwavelength <- 267\n\n#the absorbance wavelength range (nm) to be considered as a numeric string\nrangeReg <- c(240,340)\n\n#the absorbance wavelength range (nm) to be considered as a numeric string\nrangeGap <- c(255,300)\n\n#assign a variable dataAbs to a shortened version of the absorbance dataframe included in USGSHydroOpt\ndataAbs <- dfabs\n\n#define the column with the wavelengths in dataAbs\nwaveCol <- \"wavelengths\"\n\n#assign a variable grnum to the column in dataSummary with sample numbers\ncolSubsetString <- \"gr\"\n\n#assign a variable dataSummary to the dfsummary dataframe included in USGSHydroOpt,\n#column 68 or \"Aresids\" is removed because we are computing this summary optical variable\n#with this function and then adding it to dataSummary\ndataSummary <- dfsummary[,-c(68)]\n\n#assign a variable grnum to the column in dataSummary with sample numbers\ngrnum <- \"GRnumber\"\n\n#use getExpResid to calculate the residual at a given wavelength given a spectral slope calculated per Helms et al. 2008.\ntestdfOpt <- getExpResid(wavelength,rangeReg,rangeGap,dataAbs,waveCol,colSubsetString,dataSummary,grnum)\n\n#notice that the variable \"Aresids\" has been added to dataSummary\ncolnames(testdfOpt)\n@\n\n%------------------------------------------------------------\n\\subsection{Humification and Fluoresence Indices}\n%------------------------------------------------------------ \n\n\n\\end{document}",
    "created" : 1403699548907.000,
    "dirty" : false,
    "encoding" : "ISO8859-1",
    "folds" : "",
    "hash" : "4134860737",
    "id" : "D7295ECA",
    "lastKnownWriteTime" : 1403718211,
    "path" : "D:/stcData/R_projects/USGSHydroOpt/vignette/hydroOpt.Rnw",
    "project_path" : "vignette/hydroOpt.Rnw",
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "sweave"
}